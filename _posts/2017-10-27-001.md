---
layout:     post
title:      "《windows驱动开发技术详解》学习心得"
subtitle:   "第四章 驱动程序的基本结构"
date:       2017-10-27 00:05:00
author:     "SinZheng"
header-img: "img/post-bg-unix-linux.jpg"
catalog: true
tags:
    - windows内核驱动开发学习笔记
---
>梳理一下Windows驱动程序中重要的数据结构

## 驱动对象(DRIVER_OBJECT)

0. 每个驱动程序有唯一的驱动对象。
1. 该对象在驱动加载时，由对象管理器创建。
2. 驱动对象的实例被内核加载，内核对一个驱动只加载一个实例。

### 重要成员

0. `DeviceObject` 指向驱动对象的第一个设备对象，每个设备对象里也有指针指向下一个设备对象，通过该指针可以遍历该驱动创建的所有设备（设备对象的水平关系）。
1. `DriverName` 驱动程序名，一般是以"\Driver\XXX"格式的Unicode字符串。
2. `DriverStartIo` StartIO例程的函数地址，用于串行化操作。
3. `DriverUnload` 驱动卸载时的回调函数地址。
4. `MajorFunction` 数组，用于存储处理IRP的派遣函数的地址。
5. `FastIoDispatch` 文件驱动中所用到的派遣函数地址。

作者总结了一张图片：
![图片01](./01.jpg)

### MSDN DRIVER_OBJECT structure

[MSDN文档：DRIVER_OBJECT structure](https://msdn.microsoft.com/en-us/library/windows/hardware/ff544174.aspx)

## 设备对象(DEVICE_OBJECT)

0. 设备对象由驱动程序创建，每个驱动程序一般创建一个或多个设备对象。
1. 设备对象内有指针指向下一个设备对象，从而形成了设备链。

### 重要成员

0. `DriverObject` 指向驱动对象的指针，由同一个驱动程序创建的设备对象，其指向的是同一个驱动对象。
1. `NextDevice` 指向下一个设备对象的指针，正因为由此指针，设备对象之间形成了设备链。
2. `AttachedDevice` 当有更高层的驱动程序附加在当前驱动上时，该指针将指向附加在此设备上的设备对象，通过该指针实现了设备之间的垂直关系。
3. `CurrentIrp` 在使用StartIO例程时，该指针指向当前的IRP结构。
4. `Flags` 一个32位无符号整型，每一位均有具体含义，微软已经定义了相关宏。作者总结了一张常用的图：![图片02](./02.jpg)
5. `DeviceExtension` 记录着设备拓展对象，这个结构体一般由程序员自己定义。因为在驱动开发中我们应当尽量避免使用全局变量（带来的复杂的同步问题），解决办法就是将全局变量放在设备拓展中。
6. `DeviceType` 顾名思义，指定了设备类型。额~这个东西的定义非常多，作者总结了一部分。个人建议还是看微软的文档吧>_<
7. `StackSize` 当处理分层驱动时,驱动与驱动之间会形成类似堆栈的结构，IRP会从最高层依次传递到底层，该值描述的即这个层数(该值越高说明设备的层数越高，为1的是刚被创建出来的设备)。

作者总结的图：
![图片03](./03.jpg)

### MSDN DEVICE_OBJECT structure

[MSDN文档：DEVICE_OBJECT structure](https://msdn.microsoft.com/en-us/library/windows/hardware/ff543147.aspx)

## NT式驱动的基本结构

NT式驱动比较重要的即`DriverEntry`入口例程、`DriverUnload`卸载例程、处理各IRP的派遣例程。

### 驱动加载过程与驱动入口函数(DriverEntry)

0. 驱动加载时，系统进程(System)启动一个线程，该线程调用执行体组件中的对象管理器，创建`DRIVER_OBJECT`即驱动对象。
1. 系统进程调用执行体组件中的配置管理器，获取驱动程序在注册表中的项。
2. System进程调用驱动程序中的`DriverEntry()`函数，传入两个参数，第一个就是对象管理器创建的驱动对象(DRIVER_OBJECT)，第二个是配置管理器查询出的驱动程序在注册表中的项，及所谓设备服务键的键名。一般是以"\REGISTRY\MACHIHE\ControlSet\Services\XXX"这样的注册表路径字符串，该字符串是Unicode编码。

创建设备、符号链接等操作之前已专门撰文叙述，在此省略。

### DriverUnload卸载例程

略

### 分配处理IRP的派遣例程

略

## WDM式驱动的基本结构

略

